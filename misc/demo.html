<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>micro-template.js Demo</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    textarea { width: 100%; height: 7em; margin-bottom: 1em; font-family: monospace; }
    pre { background: #f8f8f8; padding: 1em; border: 1px solid #ccc; min-height: 3em; }
    label { font-weight: bold; display: block; margin-top: 1em; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>micro-template.js Demo</h1>
  <label for="template-select">テンプレート例</label>
  <select id="template-select">
    <option value="normal">通常（正常終了）</option>
    <option value="error">3行目でエラー</option>
    <option value="wrapper">wrapper() 使用例</option>
  </select>

  <label for="template">Template</label>
  <textarea id="template" placeholder="&lt;h1&gt;&lt;%= title %&gt;&lt;/h1&gt;\n&lt;p&gt;&lt;%= message %&gt;&lt;/p&gt;"></textarea>

  <label for="stash">Stash (JSON)</label>
  <textarea id="stash" placeholder='{"title": "Hello", "message": "こんにちは micro-template.js!"}'></textarea>

  <button id="render">Render</button>
  <span id="status"></span>

  <label for="output">Output</label>
  <pre id="output"></pre>

  <script type="module">
    import { extended as template } from "../lib/micro-template.js";
    window.template = template;

	template.get = function (name) {
	  return {
		wrapper: `foo: <%= foo %>\nThis is wrapper header\n<%=raw content %>\nThis is wrapper footer`
	  }[name] || '';
	};

    // テンプレート例
    const templates = {
      normal: `<h1><%= title %></h1>\n<p><%= message %></p>`,
      error: `<h1><%= title %></h1>\n<p><%= message %></p>\n<%= notfound %>`,
      wrapper: `<% wrapper('wrapper', function () { %>\n<h1>Hello, World!</h1>\n<% }) %>`
    };
    const stashes = {
      normal: {
        title: "Hello",
        message: "こんにちは micro-template.js!"
      },
      error: {
        title: "Hello",
        message: "これはエラー例です"
      },
      wrapper: {
        foo: "タイトル（wrapper用）"
      }
    };

    // UI
    const templateSelect = document.getElementById('template-select');
    const templateEl = document.getElementById('template');
    const stashEl = document.getElementById('stash');
    const outputEl = document.getElementById('output');
    const statusEl = document.getElementById('status');
    const renderBtn = document.getElementById('render');

    function render() {
      statusEl.textContent = '';
      let stash;
      try {
        stash = JSON.parse(stashEl.value);
      } catch (e) {
        outputEl.textContent = '';
        statusEl.textContent = 'JSON parse error: ' + e.message;
        statusEl.className = 'error';
        return;
      }
      try {
        const html = template(templateEl.value, stash);
        outputEl.textContent = html;
        statusEl.textContent = 'OK';
        statusEl.className = '';
      } catch (e) {
        console.log(e)
        console.error(e);
        outputEl.textContent = '';
        statusEl.textContent = 'Template error: ' + String(e);
        statusEl.className = 'error';
      }
    }
    renderBtn.addEventListener('click', render);

    // テンプレート切り替え
    templateSelect.addEventListener('change', () => {
      const key = templateSelect.value;
      templateEl.value = templates[key];
      stashEl.value = JSON.stringify(stashes[key], null, 2);
      render();
    });

    // デフォルト値
    templateSelect.value = 'normal';
    templateEl.value = templates.normal;
    stashEl.value = JSON.stringify(stashes.normal, null, 2);
    render();
  </script>
</body>
</html>
